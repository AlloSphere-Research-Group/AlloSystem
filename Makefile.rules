#=========================================================================
# Common rules
#=========================================================================

CPPFLAGS	+= $(EXT_CPPFLAGS)
LDFLAGS		+= $(EXT_LDFLAGS)

CFLAGS		:= $(CPPFLAGS) $(CFLAGS)
CXXFLAGS	:= $(CFLAGS) $(CXXFLAGS)

DEPFLAGS	=
ifneq ($(DEP_TRACK), 0)
	DEPFLAGS = -MMD -MF $(basename $@).dep
endif

ALL_BUILD_DIRS = $(BIN_DIR) $(OBJ_DIR) $(BUILD_DIR)include $(BUILD_DIR)lib

#--------------------------------------------------------------------------
# Rules
#--------------------------------------------------------------------------

# Build object file from C++ source
$(OBJ_DIR)%.o: %.cpp
	@echo CXX $< $@
	$(CXX) -c $(CXXFLAGS) $< -o $@ $(DEPFLAGS)

# Build object file from C source
$(OBJ_DIR)%.o: %.c
	@echo CC $< $@
	$(CC) -c $(CFLAGS) $< -o $@ $(DEPFLAGS)
	
# Build object file from Obj-C++ source
$(OBJ_DIR)%.o: %.mm
	@echo CC $< $@
	$(CXX) -c $(CFLAGS) $< -o $@ $(DEPFLAGS)

-include $(wildcard $(OBJ_DIR)*.dep)

all: $(SLIB_PATH)

# Build static library
#$(SLIB_PATH): createFolders $(addprefix $(OBJ_DIR), $(OBJS))
$(SLIB_PATH): $(addprefix $(OBJ_DIR), $(OBJS))
	@echo AR $@
	@$(RM) $@
	$(AR) $@ $(filter %.o, $^) $(STATIC_LIB_FLAGS)
#	@$(RANLIB) $@
#	libtool --mode=link --tag=CXX $(filter %.o, $^) $(STATIC_LIB_FLAGS) -o $@
#	@libtool -static $@ $(patsubst %, $(DEV_DIR)lib/lib%.a, $(STATIC_LIBS)) -o $@


# Dummy target to force rebuilds
FORCE:

# This creates a particular build folder
$(ALL_BUILD_DIRS):
	@mkdir -p $@

# This rule creates all the build directories ONCE when the first object is built
$(addprefix $(OBJ_DIR), $(OBJS)): | $(ALL_BUILD_DIRS)

# Create file with settings for linking to external libraries
external:
	@echo '\
CPPFLAGS += $(EXT_CPPFLAGS) \r\n\
LDFLAGS  += $(EXT_LDFLAGS) \
'> Makefile.external
